<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é€‰æ‹©é¢˜ç³»ç»Ÿ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .dark-theme {
        background-color: #012;
        color: #fff;
    }
    .container {
      display: flex;
      width: 100%;
      max-width: 1000px;
    }
    .left {
      flex: 2;
      padding-right: 20px;
    }
    .right {
      flex: 1;
      border-left: 2px solid #ccc;
      padding-left: 20px;
    }
    .question {
      font-size: 20px;
      margin-bottom: 20px;
    }
    table {
      font-size: 16px;
    }
    .options button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
    }
    .correct {
      background-color: #c8f7c5 !important;
      border-color: green;
    }
    .wrong {
      background-color: #f7c5c5 !important;
      border-color: red;
    }
    .navigation {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .analysis-button {
      visibility: hidden;
      font-size: 16px;
      border: none !important;
      outline: none;
      padding: 5px 30px 5px 30px;
      background: #ce9be3;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      -webkit-box-shadow: 4px 4px 8px 2px rgba(200, 211, 227, 0.3),
        -2px -2px 4px 1px rgba(181, 192, 227, 0.2);
      box-shadow: 4px 4px 8px 2px rgba(200, 211, 227, 0.3),
        -2px -2px 4px 1px rgba(181, 192, 227, 0.2);
      -webkit-transition: all 0.1s ease-in-out;
      -o-transition: all 0.1s ease-in-out;
      transition: all 0.1s ease-in-out;
      margin: 0 5px; /* å·¦å³é—´è· 5px */
    }
    .analysis-button:hover {
      -webkit-box-shadow: 4px 4px 8px 3px rgba(200, 211, 227, 0.5),
        -2px -2px 4px 1px rgba(181, 192, 227, 0.4);
      box-shadow: 4px 4px 8px 3px rgba(200, 211, 227, 0.5),
        -2px -2px 4px 1px rgba(181, 192, 227, 0.4);
    }
    .analysis-text {
      white-space: pre-wrap;
      font-size: 15px;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 6px;
    }
    .dark-theme .analysis-text {
      background: #0B0B0B;
    }
    .start-screen {
      max-width: 800px;
    }
    .theme-base-button{
      font-size: 16px;
      border: none !important;
      outline: none;
      padding: 5px 30px 5px 30px;
      background: #0984e3;
      background: -o-linear-gradient(70deg, #0984e3 0%, #5dc5f8 120%);
      background: linear-gradient(20deg, #0984e3 0%, #5dc5f8 120%);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      -webkit-box-shadow: 4px 4px 8px 2px rgba(9, 133, 227, 0.3),
        -2px -2px 4px 1px rgba(9, 133, 227, 0.2);
      box-shadow: 4px 4px 8px 2px rgba(9, 133, 227, 0.3),
        -2px -2px 4px 1px rgba(9, 133, 227, 0.2);
      -webkit-transition: all 0.1s ease-in-out;
      -o-transition: all 0.1s ease-in-out;
      transition: all 0.1s ease-in-out;
      margin: 0 5px; /* å·¦å³é—´è· 5px */
    }

    .theme-base-button:hover {
      -webkit-box-shadow: 4px 4px 8px 3px rgba(9, 133, 227, 0.5),
        -2px -2px 4px 1px rgba(9, 133, 227, 0.4);
      box-shadow: 4px 4px 8px 3px rgba(9, 133, 227, 0.5),
        -2px -2px 4px 1px rgba(9, 133, 227, 0.4);
    }

    /* åŸºæœ¬é‡ç½® */
    select {
      /*-webkit-appearance: none;*/ /* ç§»é™¤é»˜è®¤çš„ä¸‹æ‹‰ç®­å¤´ */
      /*-moz-appearance: none;*/
      /*appearance: none;*/
      outline: none;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      padding: 8px 12px;
      font-size: 16px;
      color: #333;
      width: 200px;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }

    /* ç¦ç”¨é€‰é¡¹çš„æ ·å¼ */
    select option[disabled] {
      color: #999;
    }

    #questionText {
      white-space: pre-wrap; /* è§£å†³é—®é¢˜ä¸­å«æœ‰æ¢è¡Œç¬¦"\nâ€œçš„æ—¶å€™ï¼Œæ¸²æŸ“ä¸ä¼šæ¢è¡Œ*/
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      margin: 2px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    .nav-btn.correct {
      background-color: #c8f7c5;
      border-color: green;
    }

    .nav-btn.wrong {
      background-color: #f7c5c5;
      border-color: red;
    }

    .annotated-word {
      color: #122e73;
      cursor: pointer;
    }

    .dark-theme .annotated-word {
      color: rgb(160,245,235);
      cursor: pointer;
    }

    #languageSelect {
      padding: 2px 6px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: white;
      color: #333;
    }

    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      background-color: #ccc;
      border-radius: 34px;
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      transition: 0.4s;
    }

    .slider::before {
      position: absolute;
      content: "ğŸŒ";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.4s;
      text-align: center;
      line-height: 20px;
      font-size: 14px;
    }

    input:checked + .slider {
      background-color: #666;
    }

    input:checked + .slider::before {
      transform: translateX(24px);
      content: "ğŸŒ™";
    }
  </style>
  <script src="book_list.js"></script>
  <script src="BlueBook_N3.js"></script>
  <script src="GPT_N3.js"></script>
  <script src="Simulate_N3.js"></script>
  <script src="JLPT_Test.js"></script>
  <script src="IT_PASSPORT_OFFICIAL.js"></script>
</head>
<body>
  <div id="navigationBar" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 16px; align-items: center;">
    <label class="theme-switch">
      <input type="checkbox" id="themeToggleSwitch" onchange="toggleTheme()" />
      <span class="slider"></span>
    </label>
    <select id="languageSelect" onchange="changeLanguage()" style="padding: 3px 6px; font-size: 14px; border-radius: 4px; width: 105px;">
      <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
      <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
      <option value="jp">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
    </select>
  </div>

<div class="start-screen" id="startScreen">
  <h2>è¯·é€‰æ‹©ä¸€æœ¬ä¹¦</h2>
  <select id="bookSelector">
    <option disabled selected>åŠ è½½ä¸­...</option>
  </select>
  <br><br>
  <h2>è¯·é€‰æ‹©å•å…ƒæˆ–éšæœºæŠ½å–é¢˜ç›®</h2>
  <select id="unitSelector">
    <option disabled selected>è¯·å…ˆé€‰æ‹©ä¸€æœ¬ä¹¦</option>
  </select>
  <br><br>
  <button onclick="startQuiz()" class="theme-base-button">å¼€å§‹ç­”é¢˜</button>
</div>

<div class="container" id="quizScreen" style="display:none;">
  <div class="left">
    <div class="question" id="questionText"></div>
    <div class="options" id="optionsContainer"></div>
    <div class="navigation">
      <button id="prevBtn" onclick="prevQuestion()" class="theme-base-button">â† ä¸Šä¸€é¢˜</button>
      <button id="analysisBtn" class="analysis-button" onclick="showAnalysis()">æŸ¥çœ‹è§£æ</button>
      <button id="nextBtn" onclick="nextQuestion()" class="theme-base-button">ä¸‹ä¸€é¢˜ â†’</button>
    </div>
  </div>
  <div class="right">
    <div style="display: flex; justify-content: space-between; align-items: right;">
      <button id="homeBtn" onclick="goBackToStart()" style="font-size: 14px; padding: 5px 10px;">è¿”å›é¦–é¡µ</button>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>è§£æ</h3>
    </div>
    <div class="analysis-text" id="analysisText">
      è¯·é€‰æ‹©é€‰é¡¹åç‚¹å‡»â€œæŸ¥çœ‹è§£æâ€ä»¥æ˜¾ç¤ºå†…å®¹ã€‚
    </div>
  </div>
</div>
<div id="questionNav" style="margin-top: 20px; display: grid; grid-template-columns: repeat(20, auto); gap: 8px;"></div>

<script>
  // display: gridï¼šç”¨ç½‘æ ¼å¸ƒå±€ã€‚
  // grid-template-columns: repeat(20, auto)ï¼šä¸€è¡Œæœ€å¤š20åˆ—ï¼Œæ¯åˆ—è‡ªåŠ¨å®½åº¦ã€‚
  // gap: 5pxï¼šæŒ‰é’®ä¹‹é—´ç•™5pxçš„é—´è·ã€‚
  // è¶…è¿‡20ä¸ªæŒ‰é’®ï¼Œä¼šè‡ªåŠ¨æ¢è¡Œåˆ°ä¸‹ä¸€è¡Œã€‚
  let allData = [];
  let filteredData = [];
  let currentIndex = 0;
  let userAnswers = [];

  const translations = {
    zh: {
      selectBook: "è¯·é€‰æ‹©ä¸€æœ¬ä¹¦",
      selectUnit: "è¯·é€‰æ‹©å•å…ƒæˆ–éšæœºæŠ½å–é¢˜ç›®",
      startQuiz: "å¼€å§‹ç­”é¢˜",
      loading: "åŠ è½½ä¸­...",
      chooseBookFirst: "è¯·å…ˆé€‰æ‹©ä¸€æœ¬ä¹¦",
      warningNoQuestion: "è¯¥å•å…ƒæ²¡æœ‰é¢˜ç›®ï¼Œè¯·æ£€æŸ¥ JSON æ•°æ®ï¼",
      questionNext: "ä¸‹ä¸€é¢˜ â†’",
      questionPrev: "â† ä¸Šä¸€é¢˜",
      home: "è¿”å›é¦–é¡µ"
    },
    en: {
      selectBook: "Please select a book",
      selectUnit: "Please select a unit or choose random questions",
      startQuiz: "Start Quiz",
      loading: "Loading...",
      chooseBookFirst: "Please select a book first",
      warningNoQuestion: "There is no question for this unit, please check the JSON data!",
      questionPrev: "â† Previous",
      questionNext: "Next â†’",
      home: "Home"
    },
    jp: {
      selectBook: "æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„",
      selectUnit: "ãƒ¦ãƒ‹ãƒƒãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€ãƒˆãƒ”ãƒƒã‚¯ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã¦ãã ã•ã„",
      startQuiz: "è³ªå•ã«ç­”ãˆå§‹ã‚ã‚‹",
      loading: "èª­ã¿è¾¼ã¿ä¸­...",
      chooseBookFirst: "ã¾ãšæœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„",
      warningNoQuestion: "ãƒ¦ãƒ‹ãƒƒãƒˆã«å•é¡Œã¯ãªã„ã®ã§ã€JSON ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      questionPrev: "â† Previous",
      questionNext: "Next â†’",
      home: "Home"
    }
  };

  function changeLanguage() {
    const lang = document.getElementById("languageSelect").value;
    localStorage.setItem("lang", lang); // ä¿å­˜ç”¨æˆ·é€‰æ‹©
    applyLanguage(lang);
  }

  function applyLanguage(lang) {
    const t = translations[lang];
    const bookSelector = document.getElementById("bookSelector");
    const currentOption = bookSelector.options[0];

    if (bookSelector.disabled) {
      // åŠ è½½ä¸­
      currentOption.textContent = t.loading;
    } else {
      // åŠ è½½å®Œæˆä½†æœªé€‰æ‹©ä¹¦
      currentOption.textContent = t.chooseBookFirst;
    }

    document.querySelector("#startScreen h2:nth-of-type(1)").textContent = t.selectBook;
    document.querySelector("#startScreen h2:nth-of-type(2)").textContent = t.selectUnit;
    document.querySelector("#unitSelector option").textContent = t.chooseBookFirst;
    document.querySelector(".theme-base-button").textContent = t.startQuiz;
    document.getElementById("prevBtn").textContent = t.questionPrev;
    document.getElementById("nextBtn").textContent = t.questionNext;
    document.getElementById("homeBtn").textContent = t.home;
  }

  // ç¬¬ä¸€æ­¥ï¼šåŠ è½½ä¹¦ç±åˆ—è¡¨
  // ç›´æ¥ç”¨ bookList
  const bookListData = bookList;

  const bookSelector = document.getElementById("bookSelector");
  // æ¸…é™¤â€œåŠ è½½ä¸­...â€è¿™ä¸ª optionï¼Œä½†ä¿ç•™ä¸€ä¸ªé»˜è®¤æç¤º
  bookSelector.innerHTML = `<option disabled selected>è¯·é€‰æ‹©ä¸€æœ¬ä¹¦</option>`;

  bookListData.forEach((book, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;  // æŠŠä¸‹æ‹‰æ¡†çš„ value è®¾æˆä¹¦çš„ç´¢å¼•
    opt.textContent = book.Title;
    document.getElementById("bookSelector").appendChild(opt);
  });

  // å½“é€‰æ‹©äº†ä¹¦æœ¬ä¹‹åï¼ŒåŠ è½½å¯¹åº”é¢˜åº“
  document.getElementById("bookSelector").addEventListener("change", function() {
    const selectedIdx = this.value;
    const savedLang = localStorage.getItem("lang") || "zh";
    const t = translations[savedLang];
    if (selectedIdx === undefined || selectedIdx === null || selectedIdx === "") return;

    const unitSelector = document.getElementById("unitSelector");
    unitSelector.innerHTML = `<option disabled selected>åŠ è½½ä¸­...</option>`;

    const bookInfo = bookList[selectedIdx];
    const dataVarName = bookInfo.DataVar;
    allData = window[dataVarName];  // <-- åŠ¨æ€æ‹¿å˜é‡é‡Œçš„é¢˜ç›®æ•°æ®

    const unitSet = new Set(allData.map(q => q.Unit));
    unitSelector.innerHTML = `<option disabled selected>` + t.selectUnit + `</option>`;
    unitSet.forEach(unit => {
      const opt = document.createElement("option");
      opt.value = unit;
      opt.textContent = `Unit ${unit}`;
      unitSelector.appendChild(opt);
    });

    const optRandom_10 = document.createElement("option");
    optRandom_10.value = "__RANDOM_10__";
    optRandom_10.textContent = "éšæœºæŠ½å– 10 é¢˜";
    unitSelector.appendChild(optRandom_10);

    const optRandom_15 = document.createElement("option");
    optRandom_15.value = "__RANDOM_15__";
    optRandom_15.textContent = "éšæœºæŠ½å– 15 é¢˜";
    unitSelector.appendChild(optRandom_15);
  });

  function shuffleOptionsAndFixAnswer(q) {
    const originalOptions = q.Option;
    const correctIndex = q["Correct Answer"] - 1;

    // åˆ›å»ºç´¢å¼•æ•°ç»„å¹¶æ‰“ä¹±
    const indices = originalOptions.map((_, i) => i);
    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }

    // ç”Ÿæˆæ–°çš„é€‰é¡¹é¡ºåº
    const shuffledOptions = indices.map(i => originalOptions[i]);

    // æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ–°ä½ç½®
    const newCorrectIndex = indices.indexOf(correctIndex);

    // è¿”å›æ–°ç»“æ„
    return {
      ...q,
      Option: shuffledOptions,
      "Correct Answer": newCorrectIndex + 1 // ä»ç„¶ç”¨ 1 å¼€å§‹
    };
  }

  function startQuiz() {
    const savedLang = localStorage.getItem("lang") || "zh";
    const t = translations[savedLang];
    const selectedUnit = document.getElementById("unitSelector").value;
    if (!selectedUnit) return alert("è¯·é€‰æ‹©ä¸€ä¸ªå•å…ƒï¼");

    if (selectedUnit === "__RANDOM_10__") {
      filteredData = allData.sort(() => Math.random() - 0.5).slice(0, 10);
    }
    else if (selectedUnit === "__RANDOM_15__") {
      filteredData = allData.sort(() => Math.random() - 0.5).slice(0, 15);
    }
    else {
      filteredData = allData.filter(q => Number(q.Unit) === Number(selectedUnit));
    }

    // å¯¹æ¯é¢˜æ‰“ä¹±é€‰é¡¹å¹¶ä¿®æ­£æ­£ç¡®ç­”æ¡ˆ
    filteredData = filteredData.map(shuffleOptionsAndFixAnswer);

    if (filteredData.length === 0) {
      alert(t.warningNoQuestion);
      return;
    }

    userAnswers = new Array(filteredData.length).fill(null);
    currentIndex = 0;
    document.getElementById("startScreen").style.display = "none";
    document.getElementById("quizScreen").style.display = "flex";
    renderQuestion(currentIndex);

    // ä¸‹æ–¹è·³è½¬é¢˜ç›®æŒ‰é’®
    const navContainer = document.getElementById("questionNav");
    navContainer.innerHTML = ""; // æ¸…ç©ºæ—§çš„
    filteredData.forEach((_, idx) => {
      const btn = document.createElement("button");
      btn.textContent = idx + 1;
      btn.id = `navBtn${idx}`;  // åŠ  ID
      btn.className = "nav-btn"; // åŠ  classï¼Œç”¨äº CSS ç»Ÿä¸€æ ·å¼
      btn.style.padding = "2px 4px";
      btn.style.textAlign = "center";  // é˜²æ­¢å¤šè¡Œæ—¶å±…å·¦
      btn.style.borderRadius = "4px";
      btn.style.border = "1px solid #aaa";
      btn.style.cursor = "pointer";

      btn.onclick = () => {
        currentIndex = idx;
        renderQuestion(currentIndex);
      };
      navContainer.appendChild(btn);
    });
  }

  function renderQuestion(index) {
    const question = filteredData[index];
    const qText = document.getElementById("questionText");
    const container = document.getElementById("optionsContainer");
    const analysisBtn = document.getElementById("analysisBtn");
    const analysisText = document.getElementById("analysisText");

    // æ¸²æŸ“å¸¦æ³¨é‡Šçš„é—®é¢˜æ–‡æœ¬
    const rawText = question.Question;
    const renderedHTML = rawText.replace(/\[([^\]]+)\]\{([^\}]+)\}/g, (match, visible, note) => {
      return `<span class="annotated-word" data-note="${note}">${visible}</span>`;
    });

    qText.innerHTML = `${index + 1}. ${renderedHTML}`;
    container.innerHTML = "";
    analysisBtn.style.visibility = "hidden";
    analysisText.textContent = "è¯·é€‰æ‹©é€‰é¡¹åç‚¹å‡»â€œæŸ¥çœ‹è§£æâ€ä»¥æ˜¾ç¤ºå†…å®¹ã€‚";

    question.Option.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.onclick = () => {
        if (userAnswers[index] == null) {
          userAnswers[index] = i + 1;
          checkAnswer(i + 1, btn, question["Correct Answer"]);
          analysisBtn.style.visibility = "visible";
        }
      };
      container.appendChild(btn);
    });

    // æ¸²æŸ“é€‰é¡¹æŒ‰é’®
    if (userAnswers[index] != null) {
      const selected = userAnswers[index];
      const buttons = document.querySelectorAll(".options button");
      buttons.forEach(btn => btn.disabled = true);
      if (selected === question["Correct Answer"]) {
        buttons[selected - 1].classList.add("correct");
      } else {
        buttons[selected - 1].classList.add("wrong");
        buttons[question["Correct Answer"] - 1].classList.add("correct");
      }
      analysisBtn.style.visibility = "visible";
      showAnalysis();
    }

    // æ§åˆ¶ä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜æŒ‰é’®çŠ¶æ€ã€‚å¦‚æœè¿™é“é¢˜æ˜¯æœ€åä¸€é¢˜åˆ™ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œå¦‚æœè¿™é“é¢˜æ˜¯ç¬¬ä¸€é¢˜åˆ™ç¦ç”¨ä¸Šä¸€é¢˜æŒ‰é’®
    const prevBtn = document.querySelector(".navigation button:nth-child(1)");
    const nextBtn = document.querySelector(".navigation button:nth-child(3)");

    if (index === 0){
        prevBtn.style.visibility = "hidden";
    }
    else {
        prevBtn.style.visibility = "visible";
    }
    if  (index === filteredData.length - 1){
        nextBtn.style.visibility = "hidden";
    }
    else {
        nextBtn.style.visibility = "visible";
    }

    document.querySelectorAll(".annotated-word").forEach(span => {
      span.addEventListener("click", () => {
        const note = span.getAttribute("data-note");
        const analysisText = document.getElementById("analysisText");
        analysisText.textContent = note;
      });
    });
  }

  function checkAnswer(selected, button, correct) {
    const buttons = document.querySelectorAll(".options button");
    buttons.forEach(btn => btn.disabled = true);
    if (selected === correct) {
      button.classList.add("correct");
    } else {
      button.classList.add("wrong");
      buttons[correct - 1].classList.add("correct");
    }

    // é«˜äº®é¢˜å·æŒ‰é’®
    const navBtn = document.querySelector(`#navBtn${currentIndex}`);
    if (selected === correct) {
      navBtn.classList.add("correct");
    } else {
      navBtn.classList.add("wrong");
    }
  }

  function showAnalysis() {
    const analysis = filteredData[currentIndex]["Analysis"];
    document.getElementById("analysisText").textContent = analysis || "æš‚æ— è§£æ";
  }

  function nextQuestion() {
    if (currentIndex < filteredData.length - 1) {
      currentIndex++;
      renderQuestion(currentIndex);
    }
  }

  function prevQuestion() {
    if (currentIndex > 0) {
      currentIndex--;
      renderQuestion(currentIndex);
    }
  }

  function goBackToStart() {
    document.getElementById("quizScreen").style.display = "none";   // éšè—ç­”é¢˜ç•Œé¢
    document.getElementById("startScreen").style.display = "block"; // æ˜¾ç¤ºé€‰ä¹¦ç•Œé¢

    // ğŸ‘‰ æ¸…ç©ºé¢˜å·æŒ‰é’®
    document.getElementById("questionNav").innerHTML = "";
  }

  // åˆ‡æ¢ä¸»é¢˜å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  function toggleTheme() {
    const body = document.querySelector('body');
    const isDark = document.getElementById("themeToggleSwitch").checked;

    if (isDark) {
      body.classList.add('dark-theme');
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.remove('dark-theme');
      localStorage.setItem('theme', 'light');
    }
  }

  function applyDefaultThemeByTime() {
    const hour = new Date().getHours(); // å½“å‰å°æ—¶æ•°
    const body = document.querySelector('body');

    // ä¼˜å…ˆè¯»å–ç”¨æˆ·æœ¬åœ°å­˜å‚¨çš„é€‰æ‹©
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        if (savedTheme === 'dark') {
            body.classList.add('dark-theme');
        } else {
            body.classList.remove('dark-theme');
        }
        return;
    }

    // å¦‚æœæ²¡æœ‰ç”¨æˆ·è®¾ç½®ï¼ŒæŒ‰æ—¶é—´è®¾ç½®
    if (hour >= 0 && hour < 5) {
        body.classList.add('dark-theme');
    } else {
        body.classList.remove('dark-theme');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const savedLang = localStorage.getItem("lang") || "zh";

    const theme = localStorage.getItem('theme') || (isNightTime() ? 'dark' : 'light');
    const isDark = theme === 'dark';

    document.getElementById("languageSelect").value = savedLang;
    applyLanguage(savedLang);
    
    document.body.classList.toggle('dark-theme', isDark);
    document.getElementById("themeToggleSwitch").checked = isDark;
  });

  function isNightTime() {
    const hour = new Date().getHours();
    return hour >= 0 && hour < 5;
  }

applyDefaultThemeByTime();

</script>

</body>
</html>
